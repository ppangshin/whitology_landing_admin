<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whitology Admin â€” Analytics Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f8f7fc;--surface:#ffffff;--surface-2:#f0eef6;
  --border:rgba(110,75,255,0.10);--border-hover:rgba(110,75,255,0.20);
  --text:#111111;--text-sub:#444466;--text-muted:#444455;
  --accent:#6E4BFF;--accent-dim:rgba(110,75,255,0.08);
  --blue:#2F6BFF;--blue-dim:rgba(47,107,255,0.08);
  --coral:#ef4444;--coral-dim:rgba(239,68,68,0.08);
  --amber:#d97706;--amber-dim:rgba(217,119,6,0.08);
  --violet:#7c3aed;--violet-dim:rgba(124,58,237,0.08);
  --green:#059669;--green-dim:rgba(5,150,105,0.08);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* NO sidebar â€” full width */
.main{padding:32px 40px;max-width:1400px;margin:0 auto;overflow-y:auto;min-height:100vh}
.main-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:12px}
.main-header h1{font-size:1.6rem;font-weight:700;color:var(--text)}
.main-header p{font-size:.92rem;color:var(--text-sub);margin-top:4px}
.main-header-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.badge-live{display:inline-flex;align-items:center;gap:6px;background:var(--green-dim);color:var(--green);padding:6px 14px;border-radius:100px;font-size:.78rem;font-weight:600}
.badge-live::before{content:'';width:6px;height:6px;background:var(--green);border-radius:50%;animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.btn-export{background:var(--surface);border:1px solid var(--border);color:var(--text-sub);padding:8px 18px;border-radius:8px;font-size:.85rem;font-weight:500;cursor:pointer;transition:all .2s;font-family:inherit;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.btn-export:hover{border-color:var(--accent);color:var(--accent)}
.btn-clear{background:var(--coral-dim);border:1px solid rgba(255,107,107,.2);color:var(--coral);padding:8px 18px;border-radius:8px;font-size:.85rem;font-weight:500;cursor:pointer;transition:all .2s;font-family:inherit}

/* Stat Cards â€” 5 columns: ë°©ë¬¸, CTAí´ë¦­+ì „í™˜ìœ¨, ì˜ˆì•½ë²„íŠ¼í´ë¦­, ì˜ˆì•½ì™„ë£Œ+ì „í™˜ìœ¨ */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:0 2px 8px rgba(110,75,255,0.04)}
.stat-card-label{display:flex;align-items:center;gap:8px;font-size:.88rem;color:var(--text-sub);font-weight:600;margin-bottom:14px}
.stat-card-icon{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem}
.stat-card-value{font-family:'JetBrains Mono',monospace;font-size:2.4rem;font-weight:600;line-height:1;margin-bottom:8px;color:var(--text)}
.stat-card-change{font-size:.82rem;font-weight:500;min-height: 32px}
.stat-card-change.up{color:var(--green)}
.stat-card-sub{font-size:.82rem;color:var(--text-sub);margin-top:6px;display:flex;align-items:center;gap:6px}
.stat-card-sub .conv-rate{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--accent);font-size:.92rem}
.stat-card-desc{font-size:.75rem;color:var(--text-muted);margin-top:10px;padding-top:10px;border-top:1px solid var(--border);line-height:1.5}

/* Charts */
.charts-row{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:28px}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px 24px 20px;box-shadow:0 2px 8px rgba(110,75,255,0.04);display:flex;flex-direction:column}
.chart-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;flex-wrap:wrap;gap:8px}
.chart-card-title{font-size:1.05rem;font-weight:600;color:var(--text)}
.chart-card-subtitle{font-size:.82rem;color:var(--text-muted)}
.date-filter{display:flex;gap:2px}
.date-filter button{background:var(--surface-2);border:1px solid var(--border);color:var(--text-sub);width:48px;padding:2px 0;border-radius:6px;font-size:.8rem;cursor:pointer;transition:all .2s;font-family:inherit;font-weight:500;line-height:1.4;display:inline-flex;align-items:center;justify-content:center}
.date-filter button.active,.date-filter button:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
/* í†µí•© í•„í„° í•œ ì¤„ */
.chart-all-filters{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.chart-all-filters button{height:32px;padding:0 12px;border-radius:6px;font-size:.8rem;font-family:inherit;font-weight:500;cursor:pointer;transition:all .2s;background:var(--surface-2);border:1px solid var(--border);color:var(--text-sub)}
.chart-all-filters button.active,.chart-all-filters button:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.chart-all-filters input[type=date]{height:32px;padding:0 10px;border:1px solid var(--border);border-radius:6px;font-size:.8rem;font-family:inherit;color:var(--text);background:var(--surface);cursor:pointer;box-sizing:border-box}
.chart-all-filters input[type=date]:focus{outline:none;border-color:var(--accent)}
.chart-all-filters .range-sep{color:var(--text-muted);font-size:.82rem;line-height:32px}
.chart-all-filters .btn-range-apply{background:var(--accent);color:#fff;border:none;font-weight:600}
.chart-all-filters .btn-range-apply:hover{opacity:.85;color:#fff}
.filter-divider{width:1px;height:20px;background:var(--border);margin:0 6px}
.chart-filters-row{display:flex;align-items:center;gap:0;flex-wrap:wrap}

.bar-chart{display:flex;align-items:flex-end;gap:3px;height:140px;padding-top:12px;padding-bottom:0;overflow:hidden;margin-top:auto}
.bar-col{flex:1;min-width:0;display:flex;flex-direction:column;align-items:center;gap:4px;height:100%;justify-content:flex-end}
.bar{width:50%;max-width:32px;border-radius:4px 4px 2px 2px;background:var(--accent);transition:height .6s;min-height:4px;opacity:.85}
.bar:hover{opacity:1}
/* 14ì¼ ì´ìƒì´ë©´ ê¸€ì”¨ ë” ì‘ê²Œ */
.bar-label{font-size:.68rem;color:var(--text-sub);font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:clip;max-width:100%;text-align:center}
.bar-value{font-size:.68rem;color:var(--text);font-family:'JetBrains Mono',monospace;font-weight:600;white-space:nowrap}
/* ë‚ ì§œ ë²”ìœ„ í•„í„° */
.date-range-filter{display:flex;align-items:center;gap:4px;margin-top:0;flex-wrap:wrap;justify-content:flex-end}
.date-range-filter input[type=date]{padding:4px 9px;border:1px solid var(--border);border-radius:6px;font-size:.8rem;font-family:inherit;color:var(--text);background:var(--surface);cursor:pointer;box-sizing:border-box}
.date-range-filter input[type=date]:focus{outline:none;border-color:var(--accent)}
.date-range-filter .range-sep{color:var(--text-muted);font-size:.82rem}
.btn-range-apply{background:var(--accent);color:#fff;border:1px solid var(--accent);border-radius:6px;font-size:.8rem;font-weight:500;cursor:pointer;font-family:inherit;transition:all .2s;width:48px;padding:2px 0;line-height:1.4;display:inline-flex;align-items:center;justify-content:center}
.btn-range-apply:hover{opacity:.85}
.btn-range-reset{background:var(--surface-2);color:var(--text-sub);border:1px solid var(--border);border-radius:6px;font-size:.8rem;font-weight:500;cursor:pointer;font-family:inherit;transition:all .2s;width:48px;padding:2px 0;line-height:1.4;display:inline-flex;align-items:center;justify-content:center}

.donut-container{display:flex;flex-direction:column;align-items:center;gap:24px;position:relative}
.donut-legend{display:flex;flex-direction:column;gap:8px;width:100%}
.legend-item{display:flex;align-items:center;justify-content:space-between;font-size:.88rem}
.legend-dot{width:8px;height:8px;border-radius:50%;margin-right:8px;display:inline-block}
.legend-left{display:flex;align-items:center;color:var(--text-sub)}
.legend-right{font-family:'JetBrains Mono',monospace;font-weight:500;color:var(--text)}

/* Demographics */
.demo-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:28px}
.demo-chart{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:0 2px 8px rgba(110,75,255,0.04)}
.demo-bars{display:flex;flex-direction:column;gap:12px;margin-top:16px}
.demo-bar-item{display:flex;align-items:center;gap:12px}
.demo-bar-label{width:60px;font-size:.85rem;color:var(--text-sub);font-weight:500;flex-shrink:0}
.demo-bar-track{flex:1;height:28px;background:var(--surface-2);border-radius:6px;overflow:hidden;position:relative}
.demo-bar-fill{height:100%;border-radius:6px;transition:width .6s;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:.75rem;font-family:'JetBrains Mono',monospace;font-weight:600;color:#fff;min-width:36px;text-shadow:0 1px 2px rgba(0,0,0,0.2)}
.demo-bar-count{font-size:.82rem;color:var(--text-sub);font-family:'JetBrains Mono',monospace;width:40px;text-align:right;flex-shrink:0}

/* Tables */
.table-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:28px;box-shadow:0 2px 8px rgba(110,75,255,0.04)}
.table-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.table-card-title{font-size:1.05rem;font-weight:600;color:var(--text)}
table{width:100%;border-collapse:collapse}
thead th{text-align:left;font-size:.8rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-sub);font-weight:600;padding:12px;border-bottom:1px solid var(--border)}
tbody td{padding:12px;font-size:.88rem;border-bottom:1px solid var(--border);font-family:'JetBrains Mono',monospace;color:var(--text-sub)}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover{background:var(--surface-2)}
.tag{display:inline-block;padding:4px 12px;border-radius:100px;font-size:.78rem;font-weight:600}
.tag-green{background:var(--green-dim);color:var(--green)}
.tag-blue{background:var(--blue-dim);color:var(--blue)}
.tag-amber{background:var(--amber-dim);color:var(--amber)}
.tag-coral{background:var(--coral-dim);color:var(--coral)}
.tag-violet{background:var(--violet-dim);color:var(--violet)}

.info-footer{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px 24px;margin-bottom:28px;box-shadow:0 2px 8px rgba(110,75,255,0.04)}
.info-footer h4{font-size:.92rem;font-weight:600;margin-bottom:10px;color:var(--text)}
.info-footer p{font-size:.82rem;color:var(--text-sub);line-height:1.7}

@media(max-width:1024px){
  .main{padding:20px}
  .stats-row{grid-template-columns:repeat(2,1fr)}
  .charts-row,.demo-row{grid-template-columns:1fr}
}
@media(max-width:640px){
  .main{padding:16px}
  .stats-row{grid-template-columns:1fr}
}
</style>
</head>
<body>
<main class="main">
  <div class="main-header">
    <div>
      <h1>Whitology Analytics Dashboard</h1>
      <p>ê³ ê° í˜ì´ì§€ ìœ ì… ë° í–‰ë™ ë°ì´í„° Â· Last updated: <span id="lastUpdate">â€”</span></p>
    </div>
    <div class="main-header-actions">
      <span class="badge-live">ì‹¤ì‹œê°„</span>
      <button class="btn-export" onclick="exportExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn-clear" onclick="clearData()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <!-- Stat Cards -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-card-label"><div class="stat-card-icon" style="background:var(--blue-dim);color:var(--blue);">ğŸ‘</div>í˜ì´ì§€ ë°©ë¬¸</div>
      <div class="stat-card-value" id="totalVisits">0</div>
      <div class="stat-card-change up" id="visitsChange">ì˜¤ëŠ˜ +0<br></div>
      <div class="stat-card-desc">ê³ ê° í˜ì´ì§€ì— ì ‘ì†í•œ ì´ íšŸìˆ˜</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label"><div class="stat-card-icon" style="background:var(--accent-dim);color:var(--accent);">ğŸ–±</div>CTA í´ë¦­</div>
      <div class="stat-card-value" id="totalClicks">0</div>
      <div class="stat-card-change up" id="clicksChange">ì˜¤ëŠ˜ +0</div>
      <div class="stat-card-sub">ì „í™˜ìœ¨ <span class="conv-rate" id="ctaConvRate">0%</span></div>
      <div class="stat-card-desc">CTA ë²„íŠ¼(ì‚¬ì „ì˜ˆì•½, í”Œë¡œíŒ… ë“±) í´ë¦­ ìˆ˜<br>ì „í™˜ìœ¨ = CTA í´ë¦­ / í˜ì´ì§€ ë°©ë¬¸ ìˆ˜</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label"><div class="stat-card-icon" style="background:var(--amber-dim);color:var(--amber);">ğŸ“</div>ì‚¬ì „ì˜ˆì•½ ì‹ ì²­ ì™„ë£Œ</div>
      <div class="stat-card-value" id="totalSubmissions">0</div>
      <div class="stat-card-change up" id="subsChange">ì˜¤ëŠ˜ +0</div>
      <div class="stat-card-sub">ì „í™˜ìœ¨ <span class="conv-rate" id="subConvRate">0%</span></div>
      <div class="stat-card-desc">ì´ë¦„Â·ì—°ë½ì²˜ ì…ë ¥ í›„ "ì‹ ì²­í•˜ê¸°" ì™„ë£Œí•œ ìˆ˜<br>ì „í™˜ìœ¨ = ì‹ ì²­ ì™„ë£Œ / í˜ì´ì§€ ë°©ë¬¸ ìˆ˜</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-label"><div class="stat-card-icon" style="background:var(--violet-dim);color:var(--violet);">ğŸ“ˆ</div>í´ë¦­â†’ì‹ ì²­ ì „í™˜ìœ¨</div>
      <div class="stat-card-value" id="clickToSubRate">0%</div>
      <div class="stat-card-change" style="color:var(--text-muted);" id="clickToSubInfo">CTA í´ë¦­ ëŒ€ë¹„<br></div>
      <div class="stat-card-desc">CTA í´ë¦­ í›„ ì‹¤ì œ ì‹ ì²­ ì™„ë£Œê¹Œì§€ì˜ ë¹„ìœ¨<br>= ì‹ ì²­ ì™„ë£Œ / CTA í´ë¦­ ìˆ˜</div>
    </div>
  </div>

  <!-- Charts + Date Filter -->
  <div class="charts-row">
    <div class="chart-card">
      <div class="chart-card-header">
        <div><div class="chart-card-title">ì¼ë³„ ë°©ë¬¸ ì¶”ì´</div><div class="chart-card-subtitle" id="chartDateRange">ìµœê·¼ 7ì¼</div></div>
        <div class="date-filter">
          <button class="active" onclick="setChartDays(7,this)">7ì¼</button>
          <button onclick="setChartDays(14,this)">14ì¼</button>
          <button onclick="setChartDays(30,this)">30ì¼</button>
        </div>
      </div>
      <div class="date-range-filter" style="margin-top:6px;">
        <input type="date" id="rangeStart">
        <span class="range-sep">~</span>
        <input type="date" id="rangeEnd">
        <button class="btn-range-apply" onclick="applyRange()">ì ìš©</button>
        <button class="btn-range-reset" onclick="resetRange()">ì´ˆê¸°í™”</button>
      </div>
      <div class="bar-chart" id="visitChart"></div>
    </div>
    <div class="chart-card">
      <div class="chart-card-header">
        <div><div class="chart-card-title">í´ë¦­ ë¶„í¬</div><div class="chart-card-subtitle">ë²„íŠ¼ë³„ ë¹„ìœ¨</div></div>
      </div>
      <div class="donut-container" id="clickDonut"></div>
    </div>
  </div>

  <!-- Demographics: Gender + Age -->
  <div class="demo-row">
    <div class="demo-chart">
      <div class="chart-card-title">ì„±ë³„ ë¶„í¬</div>
      <div class="chart-card-subtitle">ì‚¬ì „ì˜ˆì•½ ì‹ ì²­ ê¸°ì¤€</div>
      <div class="demo-bars" id="genderChart"></div>
    </div>
    <div class="demo-chart">
      <div class="chart-card-title">ì—°ë ¹ëŒ€ ë¶„í¬</div>
      <div class="chart-card-subtitle">ì‚¬ì „ì˜ˆì•½ ì‹ ì²­ ê¸°ì¤€</div>
      <div class="demo-bars" id="ageChart"></div>
    </div>
  </div>

  <!-- Submissions Table with gender/age -->
  <div class="table-card">
    <div class="table-card-header">
      <div class="table-card-title">ğŸ“‹ ì‚¬ì „ì˜ˆì•½ ì‹ ì²­ ëª©ë¡</div>
      <div style="font-size:.85rem;color:var(--text-sub);" id="subCount">0ê±´</div>
    </div>
    <div style="overflow-x:auto;">
      <table><thead><tr><th>ì‹œê°„</th><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ì´ë©”ì¼</th><th>ì„±ë³„</th><th>ì—°ë ¹ëŒ€</th><th>UTM Source</th></tr></thead>
      <tbody id="submissionsTable"><tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:40px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody></table>
    </div>
  </div>

  <!-- Traffic Sources -->
  <div class="table-card">
    <div class="table-card-header"><div class="table-card-title">ğŸ”— ìœ ì… ê²½ë¡œ ë¶„ì„</div></div>
    <div style="overflow-x:auto;">
      <table><thead><tr><th>UTM Source</th><th>UTM Medium</th><th>UTM Campaign</th><th>ë°©ë¬¸ìˆ˜</th><th>í´ë¦­ìˆ˜</th><th>ì‹ ì²­ìˆ˜</th></tr></thead>
      <tbody id="sourcesTable"><tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody></table>
    </div>
  </div>

  <!-- Definitions -->
  <div class="info-footer">
    <h4>ğŸ“Œ ì§€í‘œ ì •ì˜</h4>
    <p>
      <strong>í˜ì´ì§€ ë°©ë¬¸</strong>: ê³ ê° í˜ì´ì§€(index.html)ì— ì ‘ì†í•œ ì´ íšŸìˆ˜<br>
      <strong>CTA í´ë¦­</strong>: "ì‚¬ì „ì˜ˆì•½í•˜ê¸°", "ì¼€ì–´ ì ¤ 3ì¢… ë¬´ë£Œ ë°›ê¸°" ë“± ëª¨ë“  CTA ë²„íŠ¼ í´ë¦­ ìˆ˜ (ìƒë‹¨, íˆì–´ë¡œ, í•˜ë‹¨, í”Œë¡œíŒ… í¬í•¨)<br>
      <strong>ì‚¬ì „ì˜ˆì•½ ì‹ ì²­ ì™„ë£Œ</strong>: ëª¨ë‹¬ì—ì„œ ì´ë¦„Â·ì—°ë½ì²˜ ì…ë ¥ í›„ "ì‚¬ì „ì˜ˆì•½ ì‹ ì²­í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ìµœì¢… ì™„ë£Œí•œ ìˆ˜<br>
      <strong>CTA í´ë¦­ ì „í™˜ìœ¨</strong>: CTA í´ë¦­ ìˆ˜ / í˜ì´ì§€ ë°©ë¬¸ ìˆ˜ Ã— 100<br>
      <strong>ì‹ ì²­ ì™„ë£Œ ì „í™˜ìœ¨</strong>: ì‚¬ì „ì˜ˆì•½ ì‹ ì²­ ì™„ë£Œ ìˆ˜ / í˜ì´ì§€ ë°©ë¬¸ ìˆ˜ Ã— 100<br>
      <strong>í´ë¦­â†’ì‹ ì²­ ì „í™˜ìœ¨</strong>: ì‚¬ì „ì˜ˆì•½ ì‹ ì²­ ì™„ë£Œ ìˆ˜ / CTA í´ë¦­ ìˆ˜ Ã— 100
    </p>
  </div>
</main>

<script>
const SUPABASE_URL = 'https://gzrtrjsrwsykqscefspa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6cnRyanNyd3N5a3FzY2Vmc3BhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MzQ0MDEsImV4cCI6MjA4NzExMDQwMX0.v4MxWWoj2jUq2YjK_CdNI6Ll8bOaYmExJFshmhfMGnU';
let chartDays = 7;
let rangeStartDate = null;
let rangeEndDate = null;

async function fetchTable(table) {
  try {
    const res = await fetch(SUPABASE_URL+'/rest/v1/'+table+'?select=*&order=created_at.desc&limit=1000', {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer '+SUPABASE_KEY }
    });
    return await res.json();
  } catch(e) { return []; }
}

async function getAnalytics() {
  const [reservations, visits, clicks] = await Promise.all([
    fetchTable('reservations'),
    fetchTable('visits'),
    fetchTable('clicks')
  ]);
  return {
    submissions: reservations.map(r => ({...r, timestamp: r.created_at})),
    visits: visits.map(v => ({...v, timestamp: v.created_at})),
    clicks: clicks.map(c => ({...c, timestamp: c.created_at}))
  };
}

function formatTime(iso) {
  return new Date(iso).toLocaleString('ko-KR',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
function isToday(iso) { return new Date(iso).toDateString() === new Date().toDateString(); }

const BUTTON_LABELS = {
  'nav_cta':'ìƒë‹¨ ì‚¬ì „ì˜ˆì•½','hero_cta_primary':'íˆì–´ë¡œ CTA',
  'hero_cta_secondary':'ìì„¸íˆ ì•Œì•„ë³´ê¸°','bottom_cta':'í•˜ë‹¨ CTA','floating_cta':'í”Œë¡œíŒ… ë²„íŠ¼'
};
const BUTTON_TAGS = {
  'nav_cta':'tag-blue','hero_cta_primary':'tag-green',
  'hero_cta_secondary':'tag-amber','bottom_cta':'tag-coral','floating_cta':'tag-violet'
};
const GENDER_LABELS = {'male':'ë‚¨ì„±','female':'ì—¬ì„±','other':'ê¸°íƒ€'};
const AGE_LABELS = {'10s':'10ëŒ€','20s':'20ëŒ€','30s':'30ëŒ€','40s':'40ëŒ€','50+':'50ëŒ€ ì´ìƒ'};
function getButtonLabel(id) { return BUTTON_LABELS[id]||id; }
function getButtonTag(id) { return '<span class="tag '+(BUTTON_TAGS[id]||'tag-blue')+'">'+getButtonLabel(id)+'</span>'; }

function setChartDays(n, btn) {
  chartDays = n;
  rangeStartDate = null;
  rangeEndDate = null;
  document.getElementById('rangeStart').value = '';
  document.getElementById('rangeEnd').value = '';
  document.querySelectorAll('.date-filter button').forEach(function(b){b.classList.remove('active');});
  if(btn) btn.classList.add('active');
  renderDashboard();
}
function applyRange() {
  var s = document.getElementById('rangeStart').value;
  var e = document.getElementById('rangeEnd').value;
  if(!s || !e){ alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  if(s > e){ alert('ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
  rangeStartDate = s;
  rangeEndDate = e;
  document.querySelectorAll('.date-filter button').forEach(function(b){b.classList.remove('active');});
  renderDashboard();
}
function resetRange() {
  rangeStartDate = null;
  rangeEndDate = null;
  document.getElementById('rangeStart').value = '';
  document.getElementById('rangeEnd').value = '';
  document.querySelectorAll('.date-filter button').forEach(function(b){b.classList.remove('active');});
  document.querySelector('.date-filter button').classList.add('active');
  chartDays = 7;
  renderDashboard();
}

async function renderDashboard() {
  var data = await getAnalytics();
  var visits=data.visits, clicks=data.clicks, submissions=data.submissions;

  // Stat cards
  document.getElementById('totalVisits').textContent = visits.length;
  document.getElementById('totalClicks').textContent = clicks.length;
  document.getElementById('totalSubmissions').textContent = submissions.length;

  var todayV = visits.filter(function(v){return isToday(v.timestamp);}).length;
  var todayC = clicks.filter(function(c){return isToday(c.timestamp);}).length;
  var todayS = submissions.filter(function(s){return isToday(s.timestamp);}).length;
  document.getElementById('visitsChange').textContent = 'ì˜¤ëŠ˜ +'+todayV;
  document.getElementById('clicksChange').textContent = 'ì˜¤ëŠ˜ +'+todayC;
  document.getElementById('subsChange').textContent = 'ì˜¤ëŠ˜ +'+todayS;

  // Conversion rates
  var ctaConv = visits.length > 0 ? ((clicks.length/visits.length)*100).toFixed(1) : '0';
  var subConv = visits.length > 0 ? ((submissions.length/visits.length)*100).toFixed(1) : '0';
  var clickToSub = clicks.length > 0 ? ((submissions.length/clicks.length)*100).toFixed(1) : '0';
  document.getElementById('ctaConvRate').textContent = ctaConv+'%';
  document.getElementById('subConvRate').textContent = subConv+'%';
  document.getElementById('clickToSubRate').textContent = clickToSub+'%';

  // Bar chart with date filter or range
  var days = [];
  if(rangeStartDate && rangeEndDate) {
    var cur = new Date(rangeStartDate);
    var end = new Date(rangeEndDate);
    while(cur <= end){ days.push(cur.toISOString().split('T')[0]); cur.setDate(cur.getDate()+1); }
    document.getElementById('chartDateRange').textContent = rangeStartDate + ' ~ ' + rangeEndDate + ' (' + days.length + 'ì¼)';
  } else {
    for(var i=chartDays-1;i>=0;i--){var d=new Date();d.setDate(d.getDate()-i);days.push(d.toISOString().split('T')[0]);}
    document.getElementById('chartDateRange').textContent = 'ìµœê·¼ '+chartDays+'ì¼';
  }
  var counts = days.map(function(day){return visits.filter(function(v){return v.timestamp.startsWith(day);}).length;});
  var max = Math.max.apply(null, counts.concat([1]));
  // ë‚ ì§œ ìˆ˜ì— ë”°ë¼ ë ˆì´ë¸” í‘œì‹œ ë°©ì‹ ì¡°ì ˆ
  var labelStep = days.length > 20 ? 3 : days.length > 10 ? 2 : 1;
  document.getElementById('visitChart').innerHTML = days.map(function(day,i){
    var pct=(counts[i]/max)*100;
    var showLabel = (i % labelStep === 0);
    var label = showLabel ? new Date(day).toLocaleDateString('ko-KR',{month:'numeric',day:'numeric'}) : '';
    return '<div class="bar-col"><div class="bar-value" style="font-size:'+(days.length>20?'.6rem':'.68rem')+';">'+counts[i]+'</div><div class="bar" style="height:'+Math.max(pct,3)+'%"></div><div class="bar-label">'+label+'</div></div>';
  }).join('');

  // Donut
  var donut = document.getElementById('clickDonut');
  if(clicks.length===0){ donut.innerHTML='<p style="color:var(--text-muted);padding:40px;">í´ë¦­ ë°ì´í„° ì—†ìŒ</p>'; }
  else {
    var bc={}; clicks.forEach(function(c){bc[c.button]=(bc[c.button]||0)+1;});
    var total=clicks.length;
    var colors={'nav_cta':'var(--blue)','hero_cta_primary':'var(--green)','hero_cta_secondary':'var(--amber)','bottom_cta':'var(--coral)','floating_cta':'var(--violet)'};
    var parts=[],cum=0;
    var entries=Object.entries(bc).sort(function(a,b){return b[1]-a[1];});
    entries.forEach(function(e){
      var pct=(e[1]/total)*100;
      var col=colors[e[0]]||'var(--text-muted)';
      parts.push(col+' '+cum+'% '+(cum+pct)+'%');
      cum+=pct;
    });
    var legend=entries.map(function(e){
      var col=colors[e[0]]||'var(--text-muted)';
      var pct=((e[1]/total)*100).toFixed(0);
      return '<div class="legend-item"><span class="legend-left"><span class="legend-dot" style="background:'+col+'"></span>'+getButtonLabel(e[0])+'</span><span class="legend-right">'+e[1]+' ('+pct+'%)</span></div>';
    }).join('');
    donut.innerHTML='<div style="position:relative;width:160px;height:160px;"><div style="width:160px;height:160px;border-radius:50%;background:conic-gradient('+parts.join(',')+');-webkit-mask:radial-gradient(circle,transparent 55%,black 55.5%);mask:radial-gradient(circle,transparent 55%,black 55.5%);"></div><div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;"><div style="font-family:JetBrains Mono,monospace;font-size:1.8rem;font-weight:600;color:var(--text);">'+total+'</div><div style="font-size:.78rem;color:var(--text-muted);">ì´ í´ë¦­</div></div></div><div class="donut-legend">'+legend+'</div>';
  }

  // Gender chart
  var genderData = {};
  submissions.forEach(function(s){
    var g = s.gender || 'unknown';
    genderData[g] = (genderData[g]||0)+1;
  });
  var genderEl = document.getElementById('genderChart');
  var genderKeys = ['male','female','other','unknown'];
  var genderLabelsMap = {'male':'ë‚¨ì„±','female':'ì—¬ì„±','other':'ê¸°íƒ€','unknown':'ë¯¸ì…ë ¥'};
  var genderColors = {'male':'var(--blue)','female':'var(--coral)','other':'var(--amber)','unknown':'var(--text-muted)'};
  var genderMax = Math.max.apply(null, genderKeys.map(function(k){return genderData[k]||0;}).concat([1]));
  if(submissions.length === 0) {
    genderEl.innerHTML = '<p style="color:var(--text-muted);padding:20px;text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
  } else {
    genderEl.innerHTML = genderKeys.filter(function(k){return genderData[k];}).map(function(k){
      var count = genderData[k]||0;
      var pct = Math.round((count/genderMax)*100);
      return '<div class="demo-bar-item"><div class="demo-bar-label">'+genderLabelsMap[k]+'</div><div class="demo-bar-track"><div class="demo-bar-fill" style="width:'+pct+'%;background:'+genderColors[k]+'">'+Math.round((count/submissions.length)*100)+'%</div></div><div class="demo-bar-count">'+count+'</div></div>';
    }).join('');
  }

  // Age chart
  var ageData = {};
  submissions.forEach(function(s){
    var a = s.age || 'unknown';
    ageData[a] = (ageData[a]||0)+1;
  });
  var ageEl = document.getElementById('ageChart');
  var ageKeys = ['10s','20s','30s','40s','50+','unknown'];
  var ageLabelsMap = {'10s':'10ëŒ€','20s':'20ëŒ€','30s':'30ëŒ€','40s':'40ëŒ€','50+':'50ëŒ€+','unknown':'ë¯¸ì…ë ¥'};
  var ageColors = {'10s':'var(--green)','20s':'var(--blue)','30s':'var(--accent)','40s':'var(--amber)','50+':'var(--coral)','unknown':'var(--text-muted)'};
  var ageMax = Math.max.apply(null, ageKeys.map(function(k){return ageData[k]||0;}).concat([1]));
  if(submissions.length === 0) {
    ageEl.innerHTML = '<p style="color:var(--text-muted);padding:20px;text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
  } else {
    ageEl.innerHTML = ageKeys.filter(function(k){return ageData[k];}).map(function(k){
      var count = ageData[k]||0;
      var pct = Math.round((count/ageMax)*100);
      return '<div class="demo-bar-item"><div class="demo-bar-label">'+ageLabelsMap[k]+'</div><div class="demo-bar-track"><div class="demo-bar-fill" style="width:'+pct+'%;background:'+ageColors[k]+'">'+Math.round((count/submissions.length)*100)+'%</div></div><div class="demo-bar-count">'+count+'</div></div>';
    }).join('');
  }

  // Submissions table (with gender/age)
  document.getElementById('submissionsTable').innerHTML = submissions.length===0
    ? '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:40px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>'
    : submissions.slice().reverse().map(function(s){
      var gLabel = GENDER_LABELS[s.gender] || (s.gender ? s.gender : 'â€”');
      var aLabel = AGE_LABELS[s.age] || (s.age ? s.age : 'â€”');
      return '<tr><td>'+formatTime(s.timestamp)+'</td><td style="font-family:Noto Sans KR,sans-serif;">'+s.name+'</td><td>'+s.phone+'</td><td>'+(s.email||'â€”')+'</td><td>'+gLabel+'</td><td>'+aLabel+'</td><td>'+(s.utm_source||'<span style="color:var(--text-muted)">â€”</span>')+'</td></tr>';
    }).join('');
  document.getElementById('subCount').textContent = submissions.length+'ê±´';

  // Sources table
  var sources={};
  visits.forEach(function(v){
    var k=(v.utm_source||'direct')+'|'+(v.utm_medium||'â€”')+'|'+(v.utm_campaign||'â€”');
    if(!sources[k])sources[k]={v:0,c:0,s:0}; sources[k].v++;
  });
  clicks.forEach(function(c){
    var k=(c.utm_source||'direct')+'|â€”|'+(c.utm_campaign||'â€”');
    if(!sources[k])sources[k]={v:0,c:0,s:0}; sources[k].c++;
  });
  submissions.forEach(function(s){
    var k=(s.utm_source||'direct')+'|'+(s.utm_medium||'â€”')+'|'+(s.utm_campaign||'â€”');
    if(!sources[k])sources[k]={v:0,c:0,s:0}; sources[k].s++;
  });
  var srcEntries=Object.entries(sources).sort(function(a,b){return b[1].v-a[1].v;});
  document.getElementById('sourcesTable').innerHTML = srcEntries.length===0
    ? '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:40px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>'
    : srcEntries.map(function(e){var p=e[0].split('|');var val=e[1];return '<tr><td><span class="tag tag-blue">'+p[0]+'</span></td><td>'+p[1]+'</td><td>'+p[2]+'</td><td>'+val.v+'</td><td>'+val.c+'</td><td>'+val.s+'</td></tr>';}).join('');

  document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR');
}

async function exportExcel() {
  var d = await getAnalytics();
  var wb = XLSX.utils.book_new();

  function classifySrc(utm) {
    if(!utm || utm === 'direct') return 'ì§ì ‘ ìœ ì…';
    if(utm === 'meta' || utm === 'facebook' || utm === 'instagram') return 'ë©”íƒ€ ê´‘ê³ ';
    return 'ë§í¬ ìœ ì…';
  }

  // ì‹œíŠ¸1: ì‚¬ì „ì˜ˆì•½ ì‹ ì²­ ëª©ë¡
  var subRows = [['ì‹œê°„','ì´ë¦„','ì—°ë½ì²˜','ì´ë©”ì¼','ì„±ë³„','ì—°ë ¹ëŒ€','ìœ ì…ê²½ë¡œ']];
  var GENDER_LABELS = {'male':'ë‚¨ì„±','female':'ì—¬ì„±','other':'ê¸°íƒ€'};
  var AGE_LABELS = {'10s':'10ëŒ€','20s':'20ëŒ€','30s':'30ëŒ€','40s':'40ëŒ€','50+':'50ëŒ€ ì´ìƒ'};
  d.submissions.slice().reverse().forEach(function(s){
    subRows.push([
      new Date(s.timestamp).toLocaleString('ko-KR'),
      s.name, s.phone, s.email||'',
      GENDER_LABELS[s.gender]||(s.gender||''),
      AGE_LABELS[s.age]||(s.age||''),
      classifySrc(s.utm_source)
    ]);
  });
  var ws1 = XLSX.utils.aoa_to_sheet(subRows);
  ws1['!cols'] = [{wch:18},{wch:10},{wch:14},{wch:22},{wch:6},{wch:8},{wch:10}];
  XLSX.utils.book_append_sheet(wb, ws1, 'ì‚¬ì „ì˜ˆì•½ ì‹ ì²­');

  // ì‹œíŠ¸2: ìœ ì… ê²½ë¡œ ë¶„ì„
  var srcMap = {'ë©”íƒ€ ê´‘ê³ ':{v:0,c:0,s:0},'ë§í¬ ìœ ì…':{v:0,c:0,s:0},'ì§ì ‘ ìœ ì…':{v:0,c:0,s:0}};
  d.visits.forEach(function(v){srcMap[classifySrc(v.utm_source)].v++;});
  d.clicks.forEach(function(c){srcMap[classifySrc(c.utm_source)].c++;});
  d.submissions.forEach(function(s){srcMap[classifySrc(s.utm_source)].s++;});
  var srcRows = [['ìœ ì… ê²½ë¡œ','ë°©ë¬¸ìˆ˜','í´ë¦­ìˆ˜','ì‹ ì²­ìˆ˜','ì‹ ì²­ ì „í™˜ìœ¨']];
  Object.entries(srcMap).forEach(function(e){
    var conv = e[1].v > 0 ? ((e[1].s/e[1].v)*100).toFixed(1)+'%' : 'â€”';
    srcRows.push([e[0], e[1].v, e[1].c, e[1].s, conv]);
  });
  var ws2 = XLSX.utils.aoa_to_sheet(srcRows);
  ws2['!cols'] = [{wch:12},{wch:8},{wch:8},{wch:8},{wch:12}];
  XLSX.utils.book_append_sheet(wb, ws2, 'ìœ ì… ê²½ë¡œ ë¶„ì„');

  // ì‹œíŠ¸3: CTA í´ë¦­ ë¶„í¬
  var BUTTON_LABELS = {
    'nav_cta':'[ìƒë‹¨ ë„¤ë¹„] ì¼€ì–´ ì ¤ 3ì¢… ë¬´ë£Œ ì¦ì •',
    'hero_cta_primary':'[íˆì–´ë¡œ ë©”ì¸] ì¼€ì–´ ì ¤ 3ì¢… ë¬´ë£Œ ì¦ì •',
    'hero_cta_secondary':'[íˆì–´ë¡œ ì„œë¸Œ] ìì„¸íˆ ì•Œì•„ë³´ê¸°',
    'bottom_cta':'[í•˜ë‹¨ ì„¹ì…˜] ì˜¤ëŠ˜ë§Œ! ì¼€ì–´ ì ¤ 3ì¢… ë¬´ë£Œ ì¦ì •',
    'floating_cta':'[í”Œë¡œíŒ… ë°°ë„ˆ] ì˜¤ëŠ˜ë§Œ! ì¼€ì–´ ì ¤ 3ì¢… ë¬´ë£Œ ì¦ì •'
  };
  var clickMap = {};
  d.clicks.forEach(function(c){ clickMap[c.button]=(clickMap[c.button]||0)+1; });
  var total = d.clicks.length;
  var clickRows = [['ë²„íŠ¼','í´ë¦­ìˆ˜','ë¹„ìœ¨']];
  Object.entries(clickMap).sort(function(a,b){return b[1]-a[1];}).forEach(function(e){
    clickRows.push([BUTTON_LABELS[e[0]]||e[0], e[1], total>0 ? ((e[1]/total)*100).toFixed(1)+'%' : 'â€”']);
  });
  var ws3 = XLSX.utils.aoa_to_sheet(clickRows);
  ws3['!cols'] = [{wch:36},{wch:8},{wch:8}];
  XLSX.utils.book_append_sheet(wb, ws3, 'CTA í´ë¦­ ë¶„í¬');

  var today = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, 'whitology_analytics_'+today+'.xlsx');
}
function clearData() {
  document.getElementById('clearModal').style.display='flex';
}
function clearModalConfirm() {
  document.getElementById('clearModal').style.display='none';
  document.getElementById('clearResult').style.display='flex';
}
function clearModalCancel() {
  document.getElementById('clearModal').style.display='none';
}
function clearResultClose() {
  document.getElementById('clearResult').style.display='none';
}

setInterval(renderDashboard, 10000);
renderDashboard();
</script>

<!-- ì´ˆê¸°í™” í™•ì¸ ëª¨ë‹¬ -->
<div id="clearModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:20px;padding:36px 32px;max-width:380px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.2);text-align:center;">
    <div style="font-size:2.4rem;margin-bottom:12px;">âš ï¸</div>
    <div style="font-size:1.15rem;font-weight:700;color:#111;margin-bottom:10px;">ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
    <div style="font-size:.9rem;color:#555;line-height:1.7;margin-bottom:28px;">ì‚­ì œëœ ë°ì´í„°ëŠ” <strong>ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong><br>ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•´ ì£¼ì„¸ìš”.</div>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button onclick="clearModalCancel()" style="flex:1;padding:11px;border-radius:10px;border:1px solid #ddd;background:#f5f5f5;color:#444;font-size:.92rem;font-weight:600;cursor:pointer;font-family:inherit;">ì·¨ì†Œ</button>
      <button onclick="clearModalConfirm()" style="flex:1;padding:11px;border-radius:10px;border:none;background:#ef4444;color:#fff;font-size:.92rem;font-weight:700;cursor:pointer;font-family:inherit;">ì‚­ì œ ì§„í–‰</button>
    </div>
  </div>
</div>

<!-- ì´ˆê¸°í™” ì•ˆë‚´ ê²°ê³¼ ëª¨ë‹¬ -->
<div id="clearResult" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:20px;padding:36px 32px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.2);text-align:center;">
    <div style="font-size:2.4rem;margin-bottom:12px;">ğŸ—„ï¸</div>
    <div style="font-size:1.1rem;font-weight:700;color:#111;margin-bottom:10px;">Supabaseì—ì„œ ì§ì ‘ ì‚­ì œí•´ ì£¼ì„¸ìš”</div>
    <div style="font-size:.88rem;color:#555;line-height:1.7;margin-bottom:20px;">ë°ì´í„° ì‚­ì œëŠ” Supabase ëŒ€ì‹œë³´ë“œì—ì„œ<br>ì§ì ‘ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.</div>
    <a href="https://supabase.com/dashboard" target="_blank" style="display:inline-block;margin-bottom:20px;padding:10px 22px;background:#6E4BFF;color:#fff;border-radius:10px;font-size:.9rem;font-weight:700;text-decoration:none;">Supabase ëŒ€ì‹œë³´ë“œ ì—´ê¸° â†’</a><br>
    <button onclick="clearResultClose()" style="padding:9px 24px;border-radius:10px;border:1px solid #ddd;background:#f5f5f5;color:#444;font-size:.88rem;font-weight:600;cursor:pointer;font-family:inherit;">ë‹«ê¸°</button>
  </div>
</div>
</body>
</html>
